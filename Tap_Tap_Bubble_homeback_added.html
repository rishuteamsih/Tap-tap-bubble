<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tap Tap Bubble</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  /* ---------- Theme & layout ---------- */
  :root{
    --bg1: #f6fbff;
    --bg2: #e8f7ff;
    --card: rgba(255,255,255,0.9);
    --accent-blue: #0288d1;
    --accent-blue-2: #29b6f6;
    --accent-red: #d32f2f;
    --accent-red-2: #ef5350;
    --glass: rgba(255,255,255,0.7);
    --text: #053346;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: 'Fredoka One', Arial, sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
  .app{max-width:1000px;margin:0 auto;padding:22px;position:relative;min-height:100vh}
  .center{display:flex;align-items:center;justify-content:center}
  h1.title{font-size:56px;margin:20vh 0 8px;letter-spacing:1px;color:var(--accent-blue);text-align:center;text-shadow:0 8px 30px rgba(2,136,209,0.08)}
  p.lead{text-align:center;margin:0 0 30px;color:rgba(5,51,70,0.75)}
  .btn{border:none;padding:14px 22px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(2,136,209,0.08)}
  .btn-start{background:linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue));color:white;font-size:18px}
  nav.home-cards{display:flex;gap:18px;justify-content:center;margin-top:28px;flex-wrap:wrap}
  .card{background:var(--card);padding:18px;border-radius:14px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.06);text-align:center}
  .big-icon{font-size:44px;margin-bottom:8px}
  .small{font-size:13px;color:#235}
  .top-right{position:fixed;top:14px;right:14px;z-index:30}
  .circle{width:46px;height:46px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:white;box-shadow:0 8px 18px rgba(0,0,0,0.12);cursor:pointer}
  /* bubble bg (only visible on splash & home) */
  .bubble-bg{position:fixed;inset:0;z-index:-1;pointer-events:none;overflow:hidden}
  .bubble{position:absolute;border-radius:50%;background:rgba(255,255,255,0.22);box-shadow:inset -6px -6px 18px rgba(0,0,0,0.04);animation:rise linear infinite}
  @keyframes rise{from{transform:translateY(110vh);opacity:0}30%{opacity:0.6}to{transform:translateY(-30vh);opacity:0}}
  @keyframes drift{ 
    0%{ margin-left: 0px }
    50%{ margin-left: var(--drift, 12px) }
    100%{ margin-left: 0px }
  }
  .bubble{ position:absolute;border-radius:50%;background:rgba(255,255,255,0.22);box-shadow:inset -6px -6px 18px rgba(0,0,0,0.04);animation: rise linear infinite, drift ease-in-out infinite; will-change: transform, margin-left; }

  /* screens */
  .screen{display:none;min-height:70vh}
  .screen.active{display:block}
  /* game board */
  .hud{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .score-box{font-size:18px;font-weight:800}
  .timer-box{font-size:18px}
  .grid{display:grid;grid-template-columns:repeat(4,80px);gap:12px;justify-content:center;padding:18px}
  .cell{width:80px;height:80px;border-radius:12px;background:#f0f6fb;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 -6px 12px rgba(0,0,0,0.03);cursor:pointer;user-select:none}
  .bubble-dot{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:26px;box-shadow:0 8px 18px rgba(0,0,0,0.08)}
  .theme-blue .bubble-dot{background:linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue))}
  .theme-red .bubble-dot{background:linear-gradient(180deg,var(--accent-red-2),var(--accent-red))}
  .back-btn{position:fixed;top:14px;left:14px;background:var(--card);border-radius:10px;padding:8px 10px;box-shadow:0 10px 25px rgba(0,0,0,0.08);cursor:pointer}
  .top-right .back-btn{left:auto;right:14px}
  /* modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{background:var(--card);padding:18px;border-radius:12px;min-width:280px;max-width:520px}
  /* small helpers */
  .row{display:flex;gap:10px;align-items:center}
  .muted{color:rgba(0,0,0,0.45);font-size:13px}
  .highscore{font-weight:800;color:var(--accent-blue)}
  footer.note{position:fixed;left:12px;bottom:8px;font-size:12px;color:rgba(0,0,0,0.45)}
  @media(max-width:560px){.grid{grid-template-columns:repeat(4,56px)}.cell{width:56px;height:56px}.bubble-dot{width:44px;height:44px;font-size:18px}}

  /* ----- Layout overrides (explicit) ----- */
  .home-cards{display:flex;flex-direction:column;gap:24px;justify-content:center;align-items:center;margin-top:28px}
  @media(min-width:561px){ .home-cards{flex-direction:row;gap:18px;flex-wrap:wrap} }

  .row.equal-buttons{display:flex;gap:14px;justify-content:center}
  .row.equal-buttons .btn{flex:1;max-width:220px}

  #screen-online .row{gap:18px}

  .card{width:320px;max-width:90%}

  /* ----- Day / Night theme variables ----- */
  body.night{ --bg1: #061224; --bg2: #01203a; --card: rgba(10,16,25,0.95); --text: #e6eef8; --accent-blue: #4fc3f7; --accent-blue-2: #29b6f6; --accent-red: #ff8a80; --accent-red-2:#ff5252 }
  body.day{ /* fallback: uses existing :root vars */ }
  .circle#themeToggle{margin-left:8px}


  
  /* Corrected button sizing to prevent overflow */
  .btn.large-btn {
    width: 100%;
    max-width: 240px;
    padding: 14px 20px;
    font-size: 18px;
    box-sizing: border-box;
  }
  .row.equal-buttons .btn.large-btn {
    flex: 1;
    max-width: 240px;
  }
  @media(max-width:760px){
    .btn.large-btn{max-width:200px}
  }
  @media(max-width:560px){
    .btn.large-btn{max-width:100%}
  }
max-width:320px;padding:14px 26px;font-size:18px}
  @media(max-width:760px){ .btn.large-btn{width:220px;min-width:200px} }
  @media(max-width:560px){ .btn.large-btn{width:100%;max-width:100%} .row.equal-buttons .btn.large-btn{flex:1} }


  /* Online Play button styling to match theme */
  #toOnline.btn.large-btn{
    background:linear-gradient(180deg,var(--accent-red-2),var(--accent-red));
    color:white;
  }
  #toLocal.btn.large-btn{
    background:linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue));
    color:white;
  }


/* --- Center only the game screen card (minimal change) --- */
#screen-game.active {
  display: flex !important;
  align-items: center;
  justify-content: center;
  padding: 20px;
  min-height: calc(100vh - 40px);
  box-sizing: border-box;
}
#screen-game.active .card {
  margin: 0;
  width: min(720px, 94vw);
  max-width: 720px;
  box-sizing: border-box;
}
#screen-game.active .grid {
  margin: 0 auto;
  width: 100%;
  max-width: 420px;
}

</style>
</head>
<body>
  <div class="bubble-bg" id="bubbleBg"></div>

  <div class="app">
    <!-- top-right buttons -->
    <div class="top-right">
      <div class="circle" id="musicToggle" title="Music toggle">üîä</div>
      <div class="circle" id="themeToggle" title="Toggle theme">üåû</div>
    </div>

    <!-- Back button -->
    <div id="backBtn" class="back-btn" style="display:none">‚Üê Back</div>

    <!-- SPLASH / Main Page (page 1) -->
    <section id="screen-splash" class="screen active">
      <h1 class="title">Tap Tap Bubble</h1>
      <p class="lead">Bright, fast, and bubbly ‚Äî tap the bubbles and beat the clock!</p>
      <div class="center">
        <button class="btn btn-start" id="startToHome">Start</button>
      </div>
    </section>

    <!-- HOME (page 2) -->
    <section id="screen-home" class="screen">
  <button id="homeBackBtn" class="back-btn" aria-label="Back to splash" style="display:block;z-index:30">‚Üê Back</button>

      <!-- Home-specific back button -->

      <div class="center" style="margin-top:18px">
        <div class="home-cards">
          <div class="card">
            <div class="big-icon">üéÆ</div>
            <h3>Local Play</h3>
            <p class="small">Play on this device ‚Äî single or pass & play</p>
            <div style="margin-top:10px"><button class="btn btn-start large-btn" id="toLocal">Play Local</button></div>
          </div>
          <div class="card">
            <div class="big-icon">üåê</div>
            <h3>Online</h3>
            <p class="small">Challenge friends with a room code</p>
            <div style="margin-top:10px"><button class="btn large-btn" id="toOnline" style="background:linear-gradient(180deg,var(--accent-red-2),var(--accent-red));color:white;">Play Online</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- LOCAL MENU (page 3) -->
    <section id="screen-local" class="screen">
      <div class="card">
        <h2>Local Play</h2>
        <p class="small">High Score (Single): <span id="localHigh" class="highscore">0</span></p>
        <div class="row equal-buttons" style="justify-content:center;margin-top:14px">
          <button class="btn btn-start large-btn" id="singleBtn" style="background:linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue));color:white;">
          Single Player</button>
          <button class="btn large-btn" id="passBtn" style="background:linear-gradient(180deg,var(--accent-red-2),var(--accent-red));color:white;">
          Play & Pass</button>
        </div>
      </div>
    </section>

    <!-- ONLINE MENU -->
    <section id="screen-online" class="screen">
      <div class="card">
        <h2>Online Play</h2>
        <p class="small">Create a room to host, or join with a code.</p>
        <div style="margin-top:12px" class="row">
          <button class="btn" id="createRoomBtn" style="background:linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue));color:white;">Create Room</button>
          <button class="btn" id="joinRoomBtn" style="background:linear-gradient(180deg,var(--accent-red-2),var(--accent-red));color:white;">Join Room</button>
        </div>
      </div>
    </section>

    <!-- CREATE ROOM PAGE -->
    <section id="screen-create" class="screen">
      <div class="card">
        <h3>Create Room (Host)</h3>
        <div style="margin-top:8px" class="row">
          <input id="hostName" class="input" placeholder="Your name" style="padding:10px;border-radius:8px;border:1px solid #eee;width:60%"/>
          <button id="genRoomBtn" class="btn" style="background:linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue));color:white">Generate</button>
        </div>
        <div id="roomPanel" style="display:none;margin-top:12px">
          <p>Your Room Code:</p>
          <h2 id="roomCode" style="letter-spacing:6px"></h2>
          <button id="copyRoomBtn" class="btn">üìã Copy Code</button>
          <p class="small" style="margin-top:8px">Waiting for player 2 to join‚Ä¶</p>
        </div>
      </div>
    </section>

    <!-- JOIN ROOM PAGE -->
    <section id="screen-join" class="screen">
      <div class="card">
        <h3>Join Room</h3>
        <div style="margin-top:8px" class="row">
          <input id="joinName" class="input" placeholder="Your name" style="padding:10px;border-radius:8px;border:1px solid #eee;width:40%"/>
          <input id="joinCode" class="input" placeholder="Room code" style="padding:10px;border-radius:8px;border:1px solid #eee;width:30%"/>
          <button id="doJoinBtn" class="btn" style="background:linear-gradient(180deg,var(--accent-red-2),var(--accent-red));color:white">Join</button>
        </div>
        <p class="small" style="margin-top:10px">Enter the code provided by the host.</p>
      </div>
    </section>

    <!-- GAME SCREEN (used for single & multiplayer & pass) -->
    <section id="screen-game" class="screen">
      <div class="card">
        <div class="hud">
          <div class="score-box">Player: <span id="playerNameLabel">‚Äî</span></div>
          <div class="score-box">Score: <span id="scoreDisplay">0</span></div>
          <div class="timer-box">Time: <span id="timeDisplay">30</span>s</div>
        </div>

        <div id="countdownLarge" style="text-align:center;font-size:48px;margin:8px 0;display:none"></div>
        <div id="board" class="grid"></div>

        <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
          <button id="gameRestart" class="btn">Restart</button>
          <button id="gameHome" class="btn">Home</button>
        </div>
      </div>
    </section>

    <footer class="note">Tap Tap Bubble ‚Äî bright & simple</footer>
  </div>

  <!-- modal -->
  <div class="modal-overlay" id="modal" aria-hidden="true">
    <div class="modal" id="modalBox"></div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
  // ---- Firebase SDK (v9 modular) ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref as rref, set as rset, onValue, get as rget, update as rupdate } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  // Firestore not used here for global leaderboard to keep simpler ‚Äî single-player high score stored locally.
  // If you want server leaderboard later we can add Firestore.

  const firebaseConfig = {
    apiKey: "AIzaSyBm-szDQkdH2_ZqA_-NBdJGBkkEopVQGtg",
    authDomain: "taptapbubble1.firebaseapp.com",
    databaseURL: "https://taptapbubble1-default-rtdb.firebaseio.com",
    projectId: "taptapbubble1",
    storageBucket: "taptapbubble1.firebasestorage.app",
    messagingSenderId: "258052889537",
    appId: "1:258052889537:web:6fc9701b433d921cacad40",
    measurementId: "G-4TYXNWW4BE"
  };
  const app = initializeApp(firebaseConfig);
  const rdb = getDatabase(app);

  // ---- Simple DOM helpers ----
  const $ = id => document.getElementById(id);
  const show = el => el.classList.add('active'), hide = el => el.classList.remove('active');
  const screens = (id)=> document.querySelectorAll('.screen'); // helper

  function switchTo(screenId){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    $(screenId).classList.add('active');
    // bubble visibility: only show on splash & home
    if(screenId === 'screen-splash' || screenId === 'screen-home'){
      startBubbles();
    } else stopBubbles();
    // hide back button on main screens
    if(screenId === 'screen-splash' || screenId === 'screen-home') $('backBtn').style.display='none';
    else $('backBtn').style.display='block';
  }

  // ---- Bubble background for splash/home ----
  const bubbleBg = $('bubbleBg');
  let bubbleTimers = [];
  function spawnBubbleOnce(){
    const b = document.createElement('div');
    b.className = 'bubble';
    const size = Math.random()*80 + 20;
    b.style.width = size+'px'; b.style.height = size+'px';
    b.style.left = Math.random()*100 + 'vw';
    b.style.bottom = (-20 - Math.random()*30) + 'vh';
    b.style.opacity = (Math.random()*0.6 + 0.2);
    const dur = Math.random()*14 + 10;
        // set dual animation durations: rise and drift (drift slightly quicker)
    b.style.animationDuration = dur+'s, '+(Math.max(3, Math.round(dur*0.6)))+'s';
    // random drift amplitude
    const drift = (Math.round((Math.random()*36 - 18))) + 'px';
    b.style.setProperty('--drift', drift);

    bubbleBg.appendChild(b);
    const t = setTimeout(()=>{ b.remove(); spawnBubbleOnce(); }, (dur+1)*1000);
    bubbleTimers.push(t);
  }
  function startBubbles(){
    bubbleBg.innerHTML='';
    bubbleTimers.forEach(t=>clearTimeout(t)); bubbleTimers=[];
    for(let i=0;i<18;i++) spawnBubbleOnce();
  }
  function stopBubbles(){ bubbleTimers.forEach(t=>clearTimeout(t)); bubbleTimers=[]; bubbleBg.innerHTML=''; }

  // ---- Navigation wiring ----
  $('startToHome').addEventListener('click', ()=> { switchTo('screen-home'); });
  $('toLocal').addEventListener('click', ()=> { updateLocalHighUI(); switchTo('screen-local'); });
  $('toOnline').addEventListener('click', ()=> { switchTo('screen-online'); });
  $('backBtn').addEventListener('click', ()=> {
    // go back to home from wherever
    switchTo('screen-home');
  });

  // ---- Local High Score ----
  function getLocalHigh(){ return Number(localStorage.getItem('ttb_highscore') || 0); }
  function setLocalHigh(v){ localStorage.setItem('ttb_highscore', String(v)); }
  function updateLocalHighUI(){ $('localHigh').textContent = getLocalHigh(); }

  // ---- LOCAL PLAY: single and pass & play ----
  const BOARD_SIZE = 16;
  let game = {
    mode: 'single', // 'single', 'pass', 'online'
    timerId: null,
    countdownId: null,
    running: false,
    timeLeft: 30,
    score: 0,
    activeIdx: -1,
    playerLabel: '',
    theme: 'theme-blue',
    passTurn: 1,
    passScores: {1:0,2:0},
    onlineRoom: null,
    onlinePlayerId: null
  };

  // Build board function
  function buildBoard(){
    const board = $('board');
    board.innerHTML = '';
    for(let i=0;i<BOARD_SIZE;i++){
      const c = document.createElement('div');
      c.className = 'cell';
      c.dataset.idx = i;
      c.addEventListener('click', ()=> cellClicked(i));
      board.appendChild(c);
    }
  }
  buildBoard();

  function setTheme(theme){
    const card = document.querySelector('.app');
    card.classList.remove('theme-blue','theme-red');
    if(theme === 'blue') card.classList.add('theme-blue');
    if(theme === 'red') card.classList.add('theme-red');
  }

  function placeBubble(){
    clearBubble();
    const idx = Math.floor(Math.random()*BOARD_SIZE);
    game.activeIdx = idx;
    const cell = document.querySelector('.cell[data-idx="'+idx+'"]');
    const bubble = document.createElement('div');
    bubble.className = 'bubble-dot';
    bubble.textContent = '‚óè';
    bubble.style.transform = 'scale(0.85)';
    // theme color
    if(game.theme === 'blue') bubble.style.background = `linear-gradient(180deg,var(--accent-blue-2),var(--accent-blue))`;
    else bubble.style.background = `linear-gradient(180deg,var(--accent-red-2),var(--accent-red))`;
    cell.appendChild(bubble);
  }
  function clearBubble(){
    document.querySelectorAll('.cell').forEach(c=>c.innerHTML='');
    game.activeIdx = -1;
  }

  function cellClicked(i){
    if(!game.running) return;
    if(i === game.activeIdx){
      game.score++;
      $('scoreDisplay').textContent = game.score;
      placeBubble();
    } else {
      game.score--;
      $('scoreDisplay').textContent = game.score;
    }
  }

  function startRound(seconds=30){
    game.timeLeft = seconds; game.score = 0; game.running = true;
    $('timeDisplay').textContent = game.timeLeft;
    $('scoreDisplay').textContent = game.score;
    placeBubble();
    game.timerId = setInterval(()=>{
      game.timeLeft--;
      $('timeDisplay').textContent = game.timeLeft;
      if(game.timeLeft <= 0) endRound();
    },1000);
  }
  function stopRound(){
    if(game.timerId) { clearInterval(game.timerId); game.timerId = null; }
    game.running = false;
  }

  // Single player start
  $('singleBtn').addEventListener('click', ()=>{
    const name = prompt("Enter your name (for high score):", localStorage.getItem('ttb_name') || "");
    if(name) localStorage.setItem('ttb_name', name);
    game.mode = 'single'; game.playerLabel = name || 'Player';
    $('playerNameLabel').textContent = game.playerLabel;
    game.theme = 'blue'; setTheme('blue');
    switchToGameAndStart();
  });

  // Play & Pass
  $('passBtn').addEventListener('click', ()=>{
    const name = prompt("Player 1 name (Host):", localStorage.getItem('ttb_name') || "");
    if(name) localStorage.setItem('ttb_name', name);
    game.mode = 'pass'; game.playerLabel = name || 'Player 1';
    game.passTurn = 1; game.passScores = {1:0,2:0};
    $('playerNameLabel').textContent = (game.passTurn === 1) ? (name || 'P1') : 'P2';
    game.theme = 'blue'; setTheme('blue');
    switchToGameAndStart();
  });

  function switchToGameAndStart(){
    buildBoard();
    switchTo('screen-game');
    startCountdownThenStart(3, ()=> startRound(30));
  }

  function startCountdownThenStart(count, cb){
    $('countdownLarge').style.display = 'block';
    let c = count;
    $('countdownLarge').textContent = c;
    game.countdownId = setInterval(()=>{
      c--; if(c<=0){ clearInterval(game.countdownId); $('countdownLarge').style.display='none'; cb(); } else $('countdownLarge').textContent = c;
    },1000);
  }

  // End of round handling
  function endRound(){
    stopRound();
    clearBubble();
    if(game.mode === 'single'){
      // Save local high if better
      const prev = getLocalHigh();
      if(game.score > prev){
        setLocalHigh(game.score);
        updateLocalHighUI();
      }
      showModal(`<h3>Time's up!</h3><p>Your score: <strong>${game.score}</strong></p>
        <div style="text-align:right;margin-top:12px">
          <button id="modalRestart" class="btn" style="margin-right:8px">Restart</button>
          <button id="modalHome" class="btn">Home</button>
        </div>`);
      $('modalRestart').addEventListener('click', ()=>{ closeModal(); switchToGameAndStart(); });
      $('modalHome').addEventListener('click', ()=>{ closeModal(); switchTo('screen-home'); });
    } else if(game.mode === 'pass'){
      // save score for current player and either switch to player 2 or finish
      game.passScores[game.passTurn] = game.score;
      if(game.passTurn === 1){
        // switch to player 2
        game.passTurn = 2;
        game.playerLabel = prompt("Player 2 name (enter):", "") || "Player 2";
        $('playerNameLabel').textContent = game.playerLabel;
        game.theme = 'red'; setTheme('red');
        showModal(`<div>Pass device to Player 2 and press Start</div><div style="text-align:right;margin-top:12px"><button id="goP2" class="btn">OK</button></div>`);
        $('goP2').addEventListener('click', ()=>{ closeModal(); switchToGameAndStart(); });
      } else {
        // finished both players - show winner
        const s1 = game.passScores[1], s2 = game.passScores[2];
        let winner = s1 > s2 ? 'Player 1' : (s2 > s1 ? 'Player 2' : 'Tie');
        showModal(`<h3>Match Result</h3><p>P1: ${s1} ‚Ä¢ P2: ${s2}</p><p>Winner: <strong>${winner}</strong></p>
          <div style="text-align:right;margin-top:12px"><button id="endHome" class="btn">Home</button></div>`);
        $('endHome').addEventListener('click', ()=>{ closeModal(); switchTo('screen-home'); });
      }
    } else if(game.mode === 'online'){
      // write score to RTDB and wait for opponent result
      const room = game.onlineRoom, pid = game.onlinePlayerId;
      const scorePath = `rooms/${room}/${pid === 1 ? 'player1Score' : 'player2Score'}`;
      rset(rref(rdb, scorePath), game.score).then(()=> {
        // wait for both
        const roomRef = rref(rdb, 'rooms/' + room);
        onValue(roomRef, (snap)=>{
          const v = snap.val();
          if(v && (v.player1Score !== undefined) && (v.player2Score !== undefined)){
            // both scores present
            const p1n = v.player1 || 'P1';
            const p2n = v.player2 || 'P2';
            const s1 = Number(v.player1Score) || 0;
            const s2 = Number(v.player2Score) || 0;
            showModal(`<h3>Match Result</h3><div style="display:flex;gap:12px"><div style="flex:1"><strong>${p1n}</strong><div style="font-size:22px">${s1}</div></div><div style="flex:1"><strong>${p2n}</strong><div style="font-size:22px">${s2}</div></div></div>
              <div style="text-align:right;margin-top:12px"><button id="finishOnline" class="btn">Finish</button></div>`);
            $('finishOnline').addEventListener('click', async ()=> {
              // cleanup room
              await rset(rref(rdb, 'rooms/' + room), null);
              closeModal(); switchTo('screen-home');
            });
          }
        });
      }).catch(err=>{ alert('Failed to submit score: '+err.message); });
    }
  }

  // modal helpers
  function showModal(html){
    $('modalBox').innerHTML = html; $('modal').style.display = 'flex'; $('modal').setAttribute('aria-hidden','false');
  }
  function closeModal(){ $('modalBox').innerHTML=''; $('modal').style.display='none'; $('modal').setAttribute('aria-hidden','true'); }

  // Main restart/home buttons
  $('gameRestart').addEventListener('click', ()=>{ if(game.mode==='single') switchToGameAndStart(); else if(game.mode==='pass'){ /* restart pass mode */ game.passTurn = 1; switchToGameAndStart(); } });
  $('gameHome').addEventListener('click', ()=>{ stopRound(); clearBubble(); switchTo('screen-home'); });

  // back button behavior
  $('backBtn').addEventListener('click', ()=>{ switchTo('screen-home'); });

  // ---- ONLINE: create & join ----
  // helpers to generate code
  function makeRoomCode(len=6){
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'; // avoid ambiguous chars
    let out = '';
    for(let i=0;i<len;i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
    return out;
  }

  $('createRoomBtn').addEventListener('click', ()=> { switchTo('screen-create'); });
  $('joinRoomBtn').addEventListener('click', ()=> { switchTo('screen-join'); });

  // create room
  $('genRoomBtn').addEventListener('click', async ()=>{
    const host = $('hostName').value.trim();
    if(!host) return alert('Enter your name to host');
    const code = makeRoomCode();
    $('roomCode').textContent = code;
    $('roomPanel').style.display = 'block';
    // write initial room with player1 set
    await rset(rref(rdb, 'rooms/'+code), { player1: host, player2: null, startedAt: null });
    // listen for player2 joining
    onValue(rref(rdb, 'rooms/'+code+'/player2'), (snap)=>{
      if(snap.exists() && snap.val()){
        // set startedAt a few seconds from now to sync
        const startAt = Date.now() + 3000;
        rset(rref(rdb, 'rooms/'+code+'/startedAt'), startAt);
        // set local game state and start when startedAt triggers
        game.mode = 'online'; game.onlineRoom = code; game.onlinePlayerId = 1; $('playerNameLabel').textContent = host;
        // wait for startedAt change handled below (global)
      }
    });
    // listen for startedAt to begin
    onValue(rref(rdb, 'rooms/'+code+'/startedAt'), (s)=>{
      const val = s.val();
      if(val){
        const delay = Math.max(0, Math.ceil((val - Date.now())/1000));
        // show countdown and start
        switchTo('screen-game');
        $('playerNameLabel').textContent = host + ' (You - Blue)';
        game.theme = 'blue'; setTheme('blue');
        startCountdownThenStart(delay, ()=> startRound(30));
      }
    });
  });

  // copy room code
  $('copyRoomBtn').addEventListener('click', ()=> {
    const code = $('roomCode').textContent.trim();
    navigator.clipboard.writeText(code).then(()=> alert('Copied code'));
  });

  // join room
  $('doJoinBtn').addEventListener('click', async ()=>{
    const name = $('joinName').value.trim();
    const code = $('joinCode').value.trim().toUpperCase();
    if(!name || !code) return alert('Enter name and code');
    const roomRef = rref(rdb, 'rooms/'+code);
    const snap = await rget(roomRef);
    if(!snap.exists()) return alert('Room not found');
    const r = snap.val();
    if(r.player2) return alert('Room full');
    // set player2 and wait for startedAt
    await rset(rref(rdb, 'rooms/'+code+'/player2'), name);
    game.mode = 'online'; game.onlineRoom = code; game.onlinePlayerId = 2; $('playerNameLabel').textContent = name;
    game.theme = 'red'; setTheme('red');
    // listen for startedAt
    onValue(rref(rdb, 'rooms/'+code+'/startedAt'), (s)=>{
      const val = s.val();
      if(val){
        const delay = Math.max(0, Math.ceil((val - Date.now())/1000));
        switchTo('screen-game');
        $('playerNameLabel').textContent = name + ' (You - Red)';
        startCountdownThenStart(delay, ()=> startRound(30));
      }
    });
  });

  // ensure countdown stops and timer is disabled when time hits 0 ‚Äî handled in endRound & stopRound

  // ---- init page ----
  updateLocalHighUI();
  switchTo('screen-splash');

  // small: music toggle just UI placeholder
  $('musicToggle').addEventListener('click', ()=>{ const el=$('musicToggle'); el.textContent = (el.textContent === 'üîä') ? 'üîá' : 'üîä'; });

  
  // theme toggle (day/night)
  (function(){
    const tEl = $('themeToggle');
    if(!tEl) return;
    function applyDayNight(theme){
      document.body.classList.remove('day','night');
      document.body.classList.add(theme);
      tEl.textContent = (theme === 'night') ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('ttb_theme', theme);
    }
    const saved = localStorage.getItem('ttb_theme') || 'day';
    applyDayNight(saved);
    tEl.addEventListener('click', ()=> applyDayNight(document.body.classList.contains('night') ? 'day' : 'night'));
  })();

  // Home screen back button -> go to splash
  const hb = $('homeBackBtn'); if(hb){ hb.addEventListener('click', ()=> { switchTo('screen-splash'); }); }
</script>
</body>
</html>